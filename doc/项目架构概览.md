# 项目架构概览

## 分层设计
- **Kernel Layer**：位于 `src/kernel`，提供事件、日志、插件、系统调度、虚拟文件系统等核心服务。所有公共接口都定义在 `src/kernel/include/corona/kernel`，实现隐藏在对应的 `src/kernel/src` 下。
- **Platform Abstraction Layer (PAL)**：位于 `src/pal`，以接口形式屏蔽平台差异，当前提供文件系统与动态库加载的 Windows 实现，接口头文件位于 `src/pal/include/corona/pal`。
- **Examples 与 Tests**：示例在 `examples/`，单元及多线程压力测试在 `tests/`。测试框架为自研，入口宏位于 `tests/test_framework.h`。

## 核心单例 KernelContext
`Corona::Kernel::KernelContext` 是内核运行时的服务定位器，负责创建并持有以下组件：
- `ILogger`：多 Sink 日志系统，默认接入控制台输出。
- `IEventBus`：类型安全的发布/订阅事件总线。
- `IEventBusStream`：基于队列的事件流工厂，支持背压策略。
- `IVirtualFileSystem`：虚拟路径与物理路径映射，依赖 PAL 文件系统。
- `IPluginManager`：动态库插件加载与生命周期管理。
- `ISystemManager`：系统生命周期与帧同步调度器。

`KernelContext::initialize()` 在单线程内按依赖顺序构建以上服务，并在关闭时逆序释放。所有系统通过 `ISystemContext` 间接访问这些服务，避免直接持有全局单例。

## 事件子系统
- **概念约束**：`event/event_concepts.h` 通过 C++20 `concept` 确保事件类型可拷贝、处理器可调用。
- **事件总线**：`IEventBus` 采用类型擦除后的 `TypeErasedHandler` 存储回调，`event_bus.cpp` 中发布流程会在持锁期间复制回调列表，解锁后才逐一调用，防止死锁并屏蔽异常。
- **事件流**：`IEventBusStream` 提供面向特定事件类型的有界队列。`EventStreamOptions` 支持 `Block`、`DropOldest`、`DropNewest` 三种背压策略，`EventSubscription` 支持 `try_pop`、`wait_for`、`wait` 等消费方式。

## 系统调度
- **接口约束**：`ISystem` 定义初始化、更新、同步、线程控制与性能指标等生命周期方法；`SystemState` 描述状态机。
- **SystemBase**：`system/system_base.h` 提供线程循环、FPS 控制、暂停/恢复、统计采样等通用逻辑，并通过 `control_mutex_` 防止 `start/pause/resume/stop` 的竞态条件。
- **SystemManager**：`system/system_manager.cpp` 负责注册系统、按优先级初始化、线程级启动/停止、同步点调用以及统计汇总。内部的 `SystemContext` 将 `ISystemContext` 与 `KernelContext` 连接起来。

## 日志、插件与 VFS
- **Logger**：`core/logger.cpp` 实现控制台同步 Sink 与后台线程写文件的异步 Sink，支持动态添加/移除 Sink 以及日志级别控制。
- **PluginManager**：`core/plugin_manager.cpp` 通过 PAL `IDynamicLibrary` 装载动态库，并以自定义 deleter 管理插件对象生命周期，支持批量初始化/关闭。
- **VirtualFileSystem**：`core/vfs.cpp` 将虚拟路径映射到物理路径，内部使用 `std::map` 保存挂载点，并委托 PAL 文件系统执行具体 I/O。

## PAL 层实现
- **文件系统**：`pal/src/common/file_system.cpp` 使用 `std::filesystem` 实现二进制读写、目录遍历与创建。
- **动态库**：`pal/src/platform/windows/win_dynamic_library.cpp` 利用 Win32 API (`LoadLibraryW`/`GetProcAddress`) 实现动态库的加载与符号解析。

## 测试与质量保障
- **事件系统**：`tests/kernel/event_bus_test.cpp` 与 `event_stream_test.cpp` 覆盖基础功能、并发订阅/发布、背压策略等场景。
- **系统调度**：`tests/kernel/system_test.cpp` 与 `systemmanager_mt_test.cpp` 校验生命周期管理、状态转换与多线程安全。
- **核心服务**：`tests/kernel/logger_test.cpp`、`vfs_test.cpp`、`pluginmanager_mt_test.cpp` 等文件验证日志、虚拟文件系统与插件管理的稳定性。
- **多线程压力**：`tests/kernel/thread_safety_test.cpp` 汇总核心模块的竞态测试，确保在高并发场景下维持正确性。

以上文档概览可作为进一步深入各模块的索引，便于在 `doc/` 目录扩展更细粒度的专题文档。
