# 系统生命周期与调度

本文描述 `Corona::Kernel` 系统框架的执行模型、线程策略与性能统计，便于在自定义系统中遵循既定约束。

## ISystem 接口
位于 `src/kernel/include/corona/kernel/system/i_system.h`，核心职责：
- 标识：`get_name()`、`get_priority()`，用于日志与初始化排序。
- 生命周期：`initialize(ISystemContext*)`、`shutdown()`、`update()`、`sync()`。
- 线程控制：`start()`、`pause()`、`resume()`、`stop()`，对应 `SystemState` 状态机。
- 指标采集：`get_actual_fps()`、`get_average_frame_time()`、`get_max_frame_time()`、`get_total_frames()` 与 `reset_stats()`。

## SystemBase 提供的默认实现
`src/kernel/include/corona/kernel/system/system_base.h` 提供大部分系统都可复用的骨架：
- **线程循环**：`thread_loop()` 在独立线程上调用子类 `update()`，并根据 `target_fps_` 进行睡眠限速。
- **状态同步**：通过 `std::atomic<SystemState>` 与 `control_mutex_` 实现 `start/pause/resume/stop` 的互斥，避免 TOCTOU 竞态（见提交 `da3afaa` 的修复）。
- **暂停机制**：使用 `pause_mutex_` 与 `pause_cv_` 挂起线程，`resume()` 唤醒并继续执行。
- **帧指标**：记录帧号、`delta_time`、总帧耗时、最大帧耗时；所有统计读写均受 `stats_mutex_` 保护。

若系统继承自 `SystemBase`，只需覆盖以下成员：
```cpp
class PhysicsSystem : public SystemBase {
public:
    std::string_view get_name() const override { return "Physics"; }
    int get_priority() const override { return 100; }
    bool initialize(ISystemContext* ctx) override { /* 初始化资源 */ return true; }
    void shutdown() override { /* 清理资源 */ }
    void update() override { /* 每帧逻辑 */ }
    int get_target_fps() const override { return 120; }
};
```

## SystemManager 的职责
位于 `src/kernel/src/system/system_manager.cpp`，主要功能：
- **注册与排序**：`register_system` 将系统存入向量并按优先级（降序）排序，保证关键系统先初始化。
- **上下文桥接**：内部 `SystemContext` 实现 `ISystemContext`，把 `KernelContext` 的服务（日志、事件、VFS、插件管理器）暴露给系统，同时记录主线程的 `delta_time` 与帧编号。
- **全局生命周期**：提供 `initialize_all`、`start_all`、`pause_all`、`resume_all`、`stop_all`、`shutdown_all`、`sync_all` 等批量操作，且在初始化和停止阶段按逆序处理依赖。
- **统计查询**：`get_system_stats`/`get_all_stats` 返回 `SystemStats`，便于 UI 或调试接口展示运行状况。

## 并发与安全性
- `SystemManager` 全部公共方法使用互斥量保护，保证在多线程管理场景下不会发生数据竞争。
- 通过 `dynamic_cast` 检测系统是否继承自 `SystemBase`，若是则在注册时注入 `ISystemContext` 指针，无需调用方手动设置。
- 多线程测试 `tests/kernel/systemmanager_mt_test.cpp`、`tests/kernel/system_test.cpp` 与 `tests/kernel/thread_safety_test.cpp` 覆盖了并发注册、状态切换、暂停/恢复等操作，确保在压力场景下行为稳定。

## 最佳实践
1. **只在 `initialize` 中访问共享资源**：此函数在主线程顺序执行，适合创建事件订阅、读取配置等。
2. **避免在 `update` 中执行阻塞 I/O**：如需耗时操作，请配合 `EventStream` 或后台任务。
3. **使用 `SystemManager::sync_all()` 实现帧同步**：适用于渲染/物理等需要阶段性同步的子系统。
4. **及时调用 `stop_all()` 和 `shutdown_all()`**：确保线程先结束再释放资源，防止悬垂引用。

参照上述约定，可以快速构建符合 Corona Framework 线程模型的自定义系统，同时复用内建的性能指标与调试能力。
