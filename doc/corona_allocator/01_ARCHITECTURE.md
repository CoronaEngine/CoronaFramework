# 01 - æ€»ä½“æ¶æ„è®¾è®¡

## ğŸ“ æ¶æ„æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°å¯æ‰©å±•å†…å­˜åˆ†é…å™¨çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æ ¸å¿ƒè®¾è®¡åŸåˆ™ã€æ¨¡å—åˆ’åˆ†å’Œäº¤äº’æµç¨‹ã€‚

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. æœ€å°åŒ–ç«äº‰ (Minimize Contention)

**åŸåˆ™**: é¿å…çº¿ç¨‹é—´å…±äº«çƒ­æ•°æ®

**å®ç°ç­–ç•¥**:
- æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„ TLS æ•°æ®ç»“æ„
- å¿«é€Ÿè·¯å¾„å®Œå…¨æ— é”ï¼ˆthread-local åˆ†é…ï¼‰
- æ…¢é€Ÿè·¯å¾„ä½¿ç”¨ç²—ç²’åº¦é”ä¿æŠ¤
- è·¨çº¿ç¨‹æ“ä½œä½¿ç”¨æ— é”æ•°æ®ç»“æ„

**ä»£ç ç¤ºä¾‹**:
```cpp
// å¿«é€Ÿè·¯å¾„ï¼šå®Œå…¨æ— é”
void* fast_malloc(size_t size) {
    TLSData* tls = get_thread_tls(); // çº¿ç¨‹æœ¬åœ°
    Bin* bin = &tls->bins[get_bin_index(size)];
    Block* block = bin->active_block; // æ— ç«äº‰è®¿é—®
    
    if (block && block->has_free_space()) {
        return block->bump_allocate(); // æŒ‡é’ˆé€’å¢
    }
    return slow_malloc(tls, size); // è¿›å…¥æ…¢é€Ÿè·¯å¾„
}
```

### 2. å±€éƒ¨æ€§ä¼˜åŒ– (Locality of Reference)

**åŸåˆ™**: æœ€å¤§åŒ– CPU ç¼“å­˜åˆ©ç”¨ç‡

**å®ç°ç­–ç•¥**:
- ç¼“å­˜è¡Œå¯¹é½æ‰€æœ‰çƒ­æ•°æ®ç»“æ„
- å°†é¢‘ç¹è®¿é—®çš„å­—æ®µæ”¾åœ¨ä¸€èµ·
- é¿å… false sharing
- ä½¿ç”¨ bump pointer åˆ†é…æé«˜ç©ºé—´å±€éƒ¨æ€§

**å†…å­˜å¸ƒå±€**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block Header (128 bytes, cache-aligned)â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Hot fields (first cache line)   â”‚    â”‚
â”‚  â”‚  - bumpPtr                       â”‚    â”‚
â”‚  â”‚  - freeList                      â”‚    â”‚
â”‚  â”‚  - publicFreeList (atomic)       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Cold fields (second cache line) â”‚    â”‚
â”‚  â”‚  - metadata                      â”‚    â”‚
â”‚  â”‚  - backref                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ¸è¿›å¼å¤æ‚åº¦ (Progressive Complexity)

**åŸåˆ™**: å¸¸è§æƒ…å†µå¿«é€Ÿï¼Œç½•è§æƒ…å†µæ­£ç¡®

**å®ç°ç­–ç•¥**:
- å¿«é€Ÿè·¯å¾„ï¼šç®€å•ã€å†…è”ã€åˆ†æ”¯é¢„æµ‹å‹å¥½
- æ…¢é€Ÿè·¯å¾„ï¼šå®Œæ•´ä½†è¾ƒæ…¢çš„å¤„ç†
- æå°‘è·¯å¾„ï¼šå¯ä»¥ä½¿ç”¨å…¨å±€é”

**å†³ç­–æ ‘**:
```
malloc(size)
â”œâ”€ size <= 8128? (99% case)
â”‚  â”œâ”€ TLS initialized? (99.9% case)
â”‚  â”‚  â”œâ”€ Active block has space? (90% case)
â”‚  â”‚  â”‚  â””â”€ [FAST] Bump allocate
â”‚  â”‚  â””â”€ [MEDIUM] Get block from pool
â”‚  â””â”€ [SLOW] Initialize TLS
â””â”€ [RARE] Large object allocation
```

### 4. å†…å­˜æ•ˆç‡ (Memory Efficiency)

**åŸåˆ™**: å¹³è¡¡æ€§èƒ½å’Œå†…å­˜å¼€é”€

**å®ç°ç­–ç•¥**:
- Block å¤§å°ä¼˜åŒ–ï¼ˆ16 KBï¼‰
- æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆæœ‰ä¸Šé™ï¼‰
- å»¶è¿Ÿé‡Šæ”¾å›æ“ä½œç³»ç»Ÿ
- å†…å­˜åˆå¹¶å‡å°‘ç¢ç‰‡

---

## ğŸ—ï¸ ä¸‰å±‚æ¶æ„

### å±‚æ¬¡ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   LAYER 1: Frontend                     â”‚
â”‚                  (User-Facing API)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ malloc() â”‚  â”‚  free()  â”‚  â”‚ realloc()  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚             â”‚               â”‚                   â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â–¼        LAYER 2: Middle           â”‚
â”‚          Thread Local Storage (TLS)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Per-Thread Data Structures                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Bins   â”‚  â”‚ Block    â”‚  â”‚ Local Caches   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Array  â”‚  â”‚ Pool     â”‚  â”‚ (LOC)          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚            â”‚                 â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      â–¼            â–¼                 â–¼           â”‚  â”‚
â”‚  â”‚  Shared Structures (Careful Synchronization)   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Orphaned â”‚  â”‚  Global   â”‚  â”‚  Mailbox    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Blocks  â”‚  â”‚  Caches   â”‚  â”‚  System     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        â–¼       LAYER 3: Backend     â”‚
â”‚              Operating System Interface             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   mmap     â”‚  â”‚  VirtualAlloc â”‚  â”‚ Huge Pages â”‚ â”‚
â”‚  â”‚  (Linux)   â”‚  â”‚  (Windows)    â”‚  â”‚  Support   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Coalescing â”‚  â”‚   Address    â”‚  â”‚  Memory    â”‚ â”‚
â”‚  â”‚  Engine    â”‚  â”‚   Tracking   â”‚  â”‚  Regions   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ ¸å¿ƒæ•°æ®æµ

### åˆ†é…æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. malloc(size) è°ƒç”¨                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å¤§å°åˆ†ç±»                                              â”‚
â”‚    if (size <= 8128) â†’ å°å¯¹è±¡                           â”‚
â”‚    else              â†’ å¤§å¯¹è±¡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°å¯¹è±¡è·¯å¾„    â”‚  â”‚ å¤§å¯¹è±¡è·¯å¾„                            â”‚
â”‚              â”‚  â”‚                                       â”‚
â”‚ 3a. è®¡ç®—bin  â”‚  â”‚ 3b. æ£€æŸ¥ Local LOC                    â”‚
â”‚     ç´¢å¼•      â”‚  â”‚     å¦‚æœå‘½ä¸­ â†’ è¿”å›                   â”‚
â”‚              â”‚  â”‚     æœªå‘½ä¸­ â†“                          â”‚
â”‚ 4a. è·å–TLS  â”‚  â”‚                                       â”‚
â”‚              â”‚  â”‚ 4b. æ£€æŸ¥ Global LOC                   â”‚
â”‚ 5a. ä»bin    â”‚  â”‚     å¦‚æœå‘½ä¸­ â†’ è¿”å›                   â”‚
â”‚     çš„active â”‚  â”‚     æœªå‘½ä¸­ â†“                          â”‚
â”‚     block    â”‚  â”‚                                       â”‚
â”‚     åˆ†é…     â”‚  â”‚ 5b. ä» Backend åˆ†é…                   â”‚
â”‚              â”‚  â”‚     - mmap/VirtualAlloc               â”‚
â”‚ 6a. æˆåŠŸ?    â”‚  â”‚     - å¯¹é½åˆ°é¡µè¾¹ç•Œ                    â”‚
â”‚     æ˜¯ â†’ è¿”å›â”‚  â”‚     - æ³¨å†Œ backref                    â”‚
â”‚     å¦ â†“     â”‚  â”‚                                       â”‚
â”‚              â”‚  â”‚ 6b. æ·»åŠ åˆ° LOC                        â”‚
â”‚ 7a. è·å–æ–°   â”‚  â”‚                                       â”‚
â”‚     block    â”‚  â”‚ 7b. è¿”å›ç»™ç”¨æˆ·                        â”‚
â”‚     ä»æ± /åç«¯â”‚  â”‚                                       â”‚
â”‚              â”‚  â”‚                                       â”‚
â”‚ 8a. è®¾ç½®ä¸º   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚     active   â”‚
â”‚              â”‚
â”‚ 9a. é‡è¯•åˆ†é… â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡Šæ”¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. free(ptr) è°ƒç”¨                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŸ¥æ‰¾å¯¹è±¡å…ƒæ•°æ®                                        â”‚
â”‚    - é€šè¿‡ BackRef ç´¢å¼•                                   â”‚
â”‚    - æˆ–é€šè¿‡åœ°å€è®¡ç®—                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å°å¯¹è±¡é‡Šæ”¾    â”‚  â”‚ å¤§å¯¹è±¡é‡Šæ”¾                            â”‚
â”‚              â”‚  â”‚                                       â”‚
â”‚ 3a. è·å–æ‰€å± â”‚  â”‚ 3b. å‡å°‘å¼•ç”¨è®¡æ•°                      â”‚
â”‚     Block    â”‚  â”‚                                       â”‚
â”‚              â”‚  â”‚ 4b. å°è¯•æ·»åŠ åˆ° LOC                    â”‚
â”‚ 4a. åŒçº¿ç¨‹?  â”‚  â”‚     - æ£€æŸ¥ç¼“å­˜å¤§å°                    â”‚
â”‚              â”‚  â”‚     - æ£€æŸ¥ç¼“å­˜æ•°é‡                    â”‚
â”‚ 5a. æ˜¯:      â”‚  â”‚                                       â”‚
â”‚     æ·»åŠ åˆ°   â”‚  â”‚ 5b. LOC æ»¡?                           â”‚
â”‚     freeList â”‚  â”‚     å¦ â†’ ç¼“å­˜                         â”‚
â”‚              â”‚  â”‚     æ˜¯ â†“                              â”‚
â”‚ 5b. å¦:      â”‚  â”‚                                       â”‚
â”‚     CAS æ·»åŠ  â”‚  â”‚ 6b. åˆå¹¶ç›¸é‚»å—                        â”‚
â”‚     åˆ° publicâ”‚  â”‚                                       â”‚
â”‚     FreeList â”‚  â”‚ 7b. è¿”å›ç»™ Backend                    â”‚
â”‚              â”‚  â”‚     - munmap/VirtualFree              â”‚
â”‚ 6a. Blockç©º? â”‚  â”‚                                       â”‚
â”‚     æ˜¯ â†“     â”‚  â”‚                                       â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ 7a. é€šè¿‡     â”‚
â”‚     Mailbox  â”‚
â”‚     å½’è¿˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© æ¨¡å—åˆ’åˆ†

### Module 1: Frontend (å‰ç«¯æ¥å£)

**èŒè´£**:
- æä¾›æ ‡å‡† malloc/free/realloc API
- å‚æ•°éªŒè¯
- å¤§å°åˆ†ç±»å’Œè·¯ç”±
- å¿«é€Ÿè·¯å¾„å†…è”

**æ–‡ä»¶**:
- `frontend.h` - å…¬å…±æ¥å£å£°æ˜
- `frontend.cpp` - API å®ç°
- `malloc_export.h` - ç¬¦å·å¯¼å‡º

**å…³é”®å‡½æ•°**:
```cpp
void* corona_malloc(size_t size);
void  corona_free(void* ptr);
void* corona_realloc(void* ptr, size_t size);
void* corona_aligned_malloc(size_t size, size_t alignment);
```

### Module 2: Thread Local Storage (çº¿ç¨‹æœ¬åœ°)

**èŒè´£**:
- ç®¡ç†æ¯çº¿ç¨‹æ•°æ®ç»“æ„
- Bin æ•°ç»„ç®¡ç†
- Block æ± ç®¡ç†
- æœ¬åœ°ç¼“å­˜

**æ–‡ä»¶**:
- `thread_local.h` - TLS æ•°æ®ç»“æ„
- `thread_local.cpp` - TLS ç®¡ç†
- `bin.h` / `bin.cpp` - Bin å®ç°

**æ ¸å¿ƒç»“æ„**:
```cpp
struct TLSData {
    Bin bins[31];           // å°å¯¹è±¡ bins
    BlockPool block_pool;   // Block ç¼“å­˜
    LocalLOC loc;           // å¤§å¯¹è±¡æœ¬åœ°ç¼“å­˜
    MemoryPool* pool;       // æ‰€å±å†…å­˜æ± 
};
```

### Module 3: Block Management (å—ç®¡ç†)

**èŒè´£**:
- Block ç”Ÿå‘½å‘¨æœŸç®¡ç†
- Bump pointer åˆ†é…
- FreeList ç®¡ç†
- Public FreeList å¤„ç†

**æ–‡ä»¶**:
- `block.h` - Block ç»“æ„å®šä¹‰
- `block.cpp` - Block æ“ä½œå®ç°
- `free_list.h` - ç©ºé—²é“¾è¡¨

**æ ¸å¿ƒç»“æ„**:
```cpp
class Block {
    // çƒ­è·¯å¾„å­—æ®µï¼ˆç¬¬ä¸€ç¼“å­˜è¡Œï¼‰
    FreeObject* bump_ptr;
    FreeObject* free_list;
    std::atomic<FreeObject*> public_free_list;
    
    // å…ƒæ•°æ®ï¼ˆç¬¬äºŒç¼“å­˜è¡Œï¼‰
    uint16_t object_size;
    uint16_t allocated_count;
    TLSData* owner_tls;
};
```

### Module 4: Backend (åç«¯)

**èŒè´£**:
- æ“ä½œç³»ç»Ÿå†…å­˜åˆ†é…
- å†…å­˜åŒºåŸŸç®¡ç†
- åœ°å€ç©ºé—´è·Ÿè¸ª
- Huge Pages æ”¯æŒ

**æ–‡ä»¶**:
- `backend.h` - åç«¯æ¥å£
- `backend.cpp` - åç«¯å®ç°
- `os_mapping.h` - OS ç‰¹å®šå†…å­˜æ˜ å°„

**å¹³å°æŠ½è±¡**:
```cpp
void* map_memory(size_t size, PageType type);
bool unmap_memory(void* addr, size_t size);
size_t get_page_size();
bool supports_huge_pages();
```

### Module 5: Large Objects (å¤§å¯¹è±¡)

**èŒè´£**:
- å¤§å¯¹è±¡åˆ†é…
- å¤šçº§ç¼“å­˜ï¼ˆLocal + Globalï¼‰
- BackRef ç³»ç»Ÿ
- å¯¹è±¡åˆå¹¶

**æ–‡ä»¶**:
- `large_objects.h` - å¤§å¯¹è±¡ç»“æ„
- `large_objects.cpp` - å¤§å¯¹è±¡ç®¡ç†
- `large_cache.h` - ç¼“å­˜å®ç°
- `backref.h` / `backref.cpp` - åå‘å¼•ç”¨

### Module 6: Synchronization (åŒæ­¥)

**èŒè´£**:
- æ— é”æ•°æ®ç»“æ„
- åŸå­æ“ä½œå°è£…
- å†…å­˜å±éšœç®¡ç†
- é”å®ç°

**æ–‡ä»¶**:
- `atomic_ops.h` - åŸå­æ“ä½œ
- `spinlock.h` - è‡ªæ—‹é”
- `mutex.h` - äº’æ–¥é”
- `lockfree_stack.h` - æ— é”æ ˆ

---

## ğŸ“¦ å…³é”®æ¥å£å®šä¹‰

### 1. TLS æ¥å£

```cpp
class TLSManager {
public:
    // åˆå§‹åŒ–çº¿ç¨‹æœ¬åœ°å­˜å‚¨
    static bool initialize();
    
    // è·å–å½“å‰çº¿ç¨‹çš„ TLS
    static TLSData* get_tls();
    
    // åˆ›å»ºæ–°çš„ TLSï¼ˆé¦–æ¬¡è®¿é—®ï¼‰
    static TLSData* create_tls(MemoryPool* pool);
    
    // é”€æ¯ TLSï¼ˆçº¿ç¨‹é€€å‡ºï¼‰
    static void destroy_tls(TLSData* tls);
    
    // æ¸…ç†æœªä½¿ç”¨çš„ TLS
    static void cleanup_unused();
};
```

### 2. Block æ¥å£

```cpp
class Block {
public:
    // ä» block åˆ†é…å¯¹è±¡
    void* allocate();
    
    // æœ¬åœ°é‡Šæ”¾ï¼ˆåŒçº¿ç¨‹ï¼‰
    void free_local(void* ptr);
    
    // è·¨çº¿ç¨‹é‡Šæ”¾
    void free_public(void* ptr);
    
    // ç§æœ‰åŒ– public free list
    void privatize_public_list();
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
    bool is_empty() const;
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥é‡Šæ”¾
    bool can_be_released() const;
};
```

### 3. Backend æ¥å£

```cpp
class Backend {
public:
    // åˆå§‹åŒ–åç«¯
    bool initialize(size_t granularity);
    
    // åˆ†é…åŸå§‹å†…å­˜
    void* allocate_raw(size_t& size);
    
    // é‡Šæ”¾åŸå§‹å†…å­˜
    bool free_raw(void* ptr, size_t size);
    
    // è·å– Blockï¼ˆ16KBï¼‰
    Block* get_slab_block();
    
    // å½’è¿˜ Block
    void return_slab_block(Block* block);
    
    // å†…å­˜åˆå¹¶
    void coalesce_free_blocks();
};
```

---

## ğŸ”§ é…ç½®ç³»ç»Ÿ

### ç¼–è¯‘æ—¶é…ç½®

```cpp
// config.h
namespace config {
    // Block å¤§å°ï¼ˆå¿…é¡»æ˜¯ 2 çš„å¹‚ï¼‰
    constexpr size_t SLAB_SIZE = 16 * 1024;
    
    // ç¼“å­˜è¡Œå¤§å°
    constexpr size_t CACHE_LINE_SIZE = 128;
    
    // Bin æ•°é‡
    constexpr size_t NUM_BINS = 31;
    
    // Block æ± å¤§å°é™åˆ¶
    constexpr size_t BLOCK_POOL_HIGH_MARK = 32;
    constexpr size_t BLOCK_POOL_LOW_MARK = 8;
    
    // å¤§å¯¹è±¡ç¼“å­˜é™åˆ¶
    constexpr size_t LOCAL_LOC_MAX_SIZE = 4 * 1024 * 1024;
    constexpr size_t LOCAL_LOC_MAX_COUNT = 32;
    
    // å¯ç”¨è°ƒè¯•æ¨¡å¼
    constexpr bool DEBUG_MODE = false;
    
    // å¯ç”¨ç»Ÿè®¡ä¿¡æ¯
    constexpr bool COLLECT_STATS = false;
}
```

### è¿è¡Œæ—¶é…ç½®

```cpp
// é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶
// MALLOC_USE_HUGE_PAGES=1
// MALLOC_VERBOSE=1
// MALLOC_STATS=1
// MALLOC_DEBUG=1

class RuntimeConfig {
public:
    static bool use_huge_pages();
    static bool verbose_mode();
    static bool collect_statistics();
    static size_t huge_page_threshold();
};
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### ç»Ÿè®¡ä¿¡æ¯æ”¶é›†

```cpp
struct AllocatorStats {
    // åˆ†é…ç»Ÿè®¡
    std::atomic<uint64_t> total_allocations;
    std::atomic<uint64_t> total_frees;
    std::atomic<uint64_t> active_allocations;
    
    // å¤§å°åˆ†å¸ƒ
    std::atomic<uint64_t> small_obj_count;
    std::atomic<uint64_t> large_obj_count;
    
    // ç¼“å­˜å‘½ä¸­ç‡
    std::atomic<uint64_t> cache_hits;
    std::atomic<uint64_t> cache_misses;
    
    // è·¨çº¿ç¨‹æ“ä½œ
    std::atomic<uint64_t> cross_thread_frees;
    
    // å†…å­˜ä½¿ç”¨
    std::atomic<uint64_t> total_memory_mapped;
    std::atomic<uint64_t> total_memory_used;
    
    void print_report() const;
};
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

é˜…è¯»ä¸‹ä¸€ä¸ªæ–‡æ¡£ï¼š**[02_DATA_STRUCTURES.md](./02_DATA_STRUCTURES.md)** - è¯¦ç»†çš„æ•°æ®ç»“æ„è®¾è®¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ31æ—¥
